name: Deploy to Production

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OPA CLI
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Evaluate OPA policy
        id: policy
        run: |
          echo "Evaluating OPA policy..."
          result=$(opa eval --format=json --data policies/ --input input.json "data.cicd.allow")
          echo "OPA result: $result"
          allowed=$(echo $result | jq '.result[0].expressions[0].value')
          if [ "$allowed" != "true" ]; then
            echo "❌ Deployment blocked by OPA policy (likely Friday)."
            exit 1
          fi
          echo "✅ Deployment allowed."

      - name: Deploy to production
        if: success()
        run: |
          echo "Deploying application..."
          # your real deployment logic here

